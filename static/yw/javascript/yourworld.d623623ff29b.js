(()=>{var Ie=Object.defineProperty,Ae=Object.defineProperties;var De=Object.getOwnPropertyDescriptors;var he=Object.getOwnPropertySymbols;var He=Object.prototype.hasOwnProperty,$e=Object.prototype.propertyIsEnumerable,ue=Math.pow,de=(l,e,t)=>e in l?Ie(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t,V=(l,e)=>{for(var t in e||(e={}))He.call(e,t)&&de(l,t,e[t]);if(he)for(var t of he(e))$e.call(e,t)&&de(l,t,e[t]);return l},_=(l,e)=>Ae(l,De(e));function Fe(l){let e=null;if(document.cookie&&document.cookie!==""){let t=document.cookie.split(";"),i=0;for(;i<t.length;){let o=$.trim(t[i]);if(o.substring(0,l.length+1)===l+"="){e=decodeURIComponent(o.substring(l.length+1));break}i++}}return e}var Oe=Fe("csrftoken");function qe(l){return/^(GET|HEAD|OPTIONS|TRACE)$/.test(l)}function Ye(l){let e=document.location.host,t=document.location.protocol,i="//"+e,o=t+i;return l===o||l.slice(0,o.length+1)===o+"/"||l===i||l.slice(0,i.length+1)===i+"/"||!/^(\/\/|http:|https:).*/.test(l)}function pe(){$.ajaxSetup({beforeSend:(l,e)=>{!qe(e.type)&&Ye(e.url)&&l.setRequestHeader("X-CSRFToken",Oe)}})}function C(l,e){if(!l)throw new Error(e||"Assertion failed")}var N=(l,e)=>l-e*Math.floor(l/e),F={_getNodeIndex:l=>$(l).parent().children().index(l),addCss:l=>{let e=document.createElement("style");return e.styleSheet?e.styleSheet.cssText=l:e.appendChild(document.createTextNode(l)),document.getElementsByTagName("head")[0].appendChild(e),e},charAt:(l,e)=>{let t=l.charAt(e),i=l.charAt(e+1);return F.isSurrogate(t,i)?t+i:t},escapeChar:l=>l==="<"?"&lt;":l===">"?"&gt;":l==="&"?"&amp;":l===" "?"&nbsp;":l,getChars:l=>{let e=[],t=-1;for(;++t<l.length;){let i=l.charAt(t),o=l.charAt(t+1);F.isSurrogate(i,o)?(e.push(i+o),t++):e.push(i)}return e},isSurrogate:(...l)=>{for(let e of l){let t=e.charCodeAt(0);if(t<55296||t>57343)return!1}return!0},length:l=>F.getChars(l).length,vectorLen:(...l)=>{let e=0;for(let t of l)e+=t*t;return Math.sqrt(e)}},x=F;var me=!1,m;(function(i){i[i.PUBLIC=0]="PUBLIC",i[i.MEMBERS=1]="MEMBERS",i[i.ADMIN=2]="ADMIN"})(m||(m={}));function fe(l){switch(l){case 2:return"owner-only";case 1:return"member-only";default:return"public"}}var Z=class{constructor(e,t){this.user=e;this.world=t;this.canAdmin=()=>this.user.authenticated&&(this.user.is_superuser||this.user.id===this.world.owner_id);this.canCoordlink=e=>(e?this.canEditTile(e):this.canWrite())&&this.userMatchesPerm(this.world.feature_coord_link);this.canEditTile=e=>me||!this.canRead()?!1:e.writability===null?this.canWrite():this.userMatchesPerm(e.writability);this.canGoToCoord=()=>this.canRead()&&this.userMatchesPerm(this.world.feature_go_to_coord);this.canZoom=()=>this.canRead()&&this.world.feature_zoom;this.canPaste=()=>this.canWrite()&&this.userMatchesPerm(this.world.feature_paste);this.canProtectTiles=()=>this.canAdmin()?!0:this.world.feature_membertiles_addremove&&this.user.whitelists.includes(this.world.id);this.canRead=()=>this.userMatchesPerm(this.world.readability);this.canUrllink=e=>(e?this.canEditTile(e):this.canWrite())&&this.userMatchesPerm(this.world.feature_url_link);this.canWrite=()=>!me&&this.canRead()&&this.userMatchesPerm(this.world.writability);this.getPermDisplay=e=>({0:"PUBLIC",1:"MEMBERS",2:"ADMIN"})[e];this.userMatchesPerm=e=>e===0?!0:this.user.authenticated?this.canAdmin()?!0:e===2?!1:(C(e===1),this.user.whitelists.includes(this.world.id)):!1}};var Q=class{constructor(){this.openCallback=()=>{};this.closeCallback=()=>{};this.onOpen=e=>{this.openCallback=e};this.onClose=e=>{this.closeCallback=e};this.close=()=>{$("#coord_input_cancel").trigger("click")};this.onSubmit=()=>{let e=this.$el.find("form")[0],t=parseInt(e.coord_input_Y.value,10),i=parseInt(e.coord_input_X.value,10),o=!1;return isNaN(t)?(o=!0,$(e.coord_input_Y).css("border","1px solid red")):($(e.coord_input_Y).css("border",""),e.coord_input_Y.value=t),isNaN(i)?(o=!0,$(e.coord_input_X).css("border","1px solid red")):($(e.coord_input_X).css("border",""),e.coord_input_X.value=i),o||(this.close(),setTimeout(()=>this.callback({x:i,y:t}),0)),!1};this.$el=$("#coordinate_input_modal"),C(this.$el.length===1),this.el=this.$el[0],this.$el.find("form").on("submit",this.onSubmit)}open(e,t){return $("#coord_input_title").text(e),this.callback=t,this.$el.modal({minHeight:80,minWidth:160,persist:!0,onShow:this.openCallback,onClose:()=>{this.closeCallback(),$.modal.close()}})}},ge=Q;var K=class{constructor(){this.openCallback=()=>{};this.closeCallback=()=>{};this.onOpen=e=>{this.openCallback=e};this.onClose=e=>{this.closeCallback=e};this.close=()=>{$("#url_input_cancel").trigger("click")};this.onSubmit=()=>{var e=$("#url_input_form_input").val();return this.close(),setTimeout(()=>this.callback(e),0),!1};this.$el=$("#url_input_modal"),C(this.$el.length===1),this.el=this.$el[0],this.$el.find("form").on("submit",this.onSubmit)}open(e){return this.callback=e,this.$el.modal({minHeight:80,minWidth:160,persist:!0,onShow:this.openCallback,onClose:()=>{this.closeCallback(),$.modal.close()}})}},be=K;var T=class{constructor(e,t,i,o){this.left=e;this.top=t;this.right=i;this.bottom=o;this.toString=()=>`Rectangle { left: ${this.left}, top: ${this.top}, right: ${this.right}, bottom: ${this.bottom}`;this.sub=e=>new T(this.left-e.left,this.top-e.top,this.right-e.right,this.bottom-e.bottom);this.scale=(e,t)=>new T(this.left*e,this.top*t,this.right*e,this.bottom*t);this.center=()=>({x:this.left+.5*(this.right-this.left),y:this.top+.5*(this.bottom-this.top)});this.serialize=()=>({minX:this.left,minY:this.top,maxX:this.right-1,maxY:this.bottom-1});this.contains=e=>e.x>=this.left&&e.x<this.right&&e.y>=this.top&&e.y<this.bottom;this.offset=e=>new T(this.left+e.x,this.top+e.y,this.right+e.x,this.bottom+e.y);this.sharesEdge=e=>e.top===this.bottom||e.bottom===this.top?e.left===this.left&&e.right===this.right:e.left===this.right||e.right===this.left?e.top===this.top&&e.bottom===this.bottom:!1;this.merge=e=>this.sharesEdge(e)?e.top===this.bottom?new T(this.left,this.top,this.right,e.bottom):e.bottom===this.top?new T(this.left,e.top,this.right,this.bottom):e.left===this.right?new T(this.left,this.top,e.right,this.bottom):e.right===this.left?new T(e.left,this.top,this.right,this.bottom):this:this;this.equals=e=>this.left==e.left&&this.right==e.right&&this.top==e.top&&this.bottom==e.bottom}get width(){return this.right-this.left}get height(){return this.bottom-this.top}get topLeft(){return{x:this.left,y:this.top}}get bottomRight(){return{x:this.right,y:this.bottom}}},A=T;A.fromString=e=>{let[t,i,o,r]=e.split(",").map(n=>parseInt(n));return new T(o,t,r,i)},A.fromCoords=function(e,t){return new T(e.x,e.y,t.x,t.y)};var v=A;var c=class{static get cellWidth(){return 10*c.pixelScale}static get cellHeight(){return 18*c.pixelScale}static get tileWidth(){return c.numCols*c.cellWidth}static get tileHeight(){return c.numRows*c.cellHeight}},d=c;d.numRows=8,d.numCols=16,d.pixelScale=devicePixelRatio,d.screenSize={x:0,y:0},d.setScreenSize=(e,t)=>{c.screenSize={x:e,y:t}},d.renderThreshhold=30,d.defaultColors={text:"#000000",ownerTile:"#dddddd",memberTile:"#eeeeee",publicTile:"#ffffff",inputCursor:"#ffff00",guestCursor:"#eeeeff",mouseCursor:"#aaaaff",coordLink:"#008000",urlLink:"#0000ff",cellHighlight:"#ffff99"},d.colors={text:c.defaultColors.text,ownerTile:c.defaultColors.ownerTile,memberTile:c.defaultColors.memberTile,publicTile:c.defaultColors.publicTile,inputCursor:c.defaultColors.inputCursor,guestCursor:c.defaultColors.guestCursor,mouseCursor:c.defaultColors.mouseCursor,coordLink:c.defaultColors.coordLink,urlLink:c.defaultColors.urlLink,cellHighlight:c.defaultColors.cellHighlight},d.setColor=(e,t)=>{c.colors.hasOwnProperty(e)&&(t.length>0?c.colors[e]=t:c.colors[e]=c.defaultColors[e])},d.highlightTime=500,d.rateLimits={fetch:10,write:2,cursor:35},d.fetchRect=()=>new v(-1*c.screenSize.x,-1*c.screenSize.y,c.screenSize.x+1*c.screenSize.x,c.screenSize.y+1*c.screenSize.y),d.cleanupRect=()=>new v(-2*c.screenSize.x,-2*c.screenSize.y,c.screenSize.x+2*c.screenSize.x,c.screenSize.y+2*c.screenSize.y),d.performanceCategories={default:!0,rendering:!0,scrolling:!0,memory:!0,network:!1},d.debug={drawTileBorders:!1,drawTileCoords:!1,preserveTiles:!1,showMinimap:!1},d.showDebug={network:!0};var s=d;var b=class{},u=b;u.screenToWorld=(e,t,i)=>({x:e.x/i.amount+t.x,y:e.y/i.amount+t.y}),u.worldToScreen=(e,t,i)=>({x:(e.x-t.x)*i.amount,y:(e.y-t.y)*i.amount}),u.cssToWorld=(e,t,i)=>b.screenToWorld({x:e.x*s.pixelScale,y:e.y*s.pixelScale},t,i),u.tileToWorld=e=>({x:e.x*s.tileWidth,y:e.y*s.tileHeight}),u.worldToTile=e=>({x:Math.floor(e.x/s.tileWidth),y:Math.floor(e.y/s.tileHeight)}),u.cellToWorld=e=>({x:e.x*s.cellWidth,y:e.y*s.cellHeight}),u.worldToCell=e=>({x:Math.floor(e.x/s.cellWidth),y:Math.floor(e.y/s.cellHeight)}),u.displayToWorld=e=>({x:e.x*4*s.tileWidth,y:-e.y*4*s.tileHeight}),u.worldToDisplay=e=>({x:Math.floor(e.x/(4*s.tileWidth)),y:-Math.floor(e.y/(4*s.tileHeight))}),u.fullToWorld=e=>({x:e.tileX*s.tileWidth+e.charX*s.cellWidth,y:e.tileY*s.tileHeight+e.charY*s.cellHeight}),u.worldToFull=e=>({tileX:Math.floor(e.x/s.tileWidth),tileY:Math.floor(e.y/s.tileHeight),charX:N(Math.floor(e.x/s.cellWidth),s.numCols),charY:N(Math.floor(e.y/s.cellHeight),s.numRows)}),u.cellToFullCoords=e=>b.worldToFull(b.cellToWorld(e)),u.cellToTile=e=>b.worldToTile(b.cellToWorld(e)),u.screenToTile=(e,t,i)=>b.worldToTile(b.screenToWorld(e,t,i)),u.fullToCell=e=>b.worldToCell(b.fullToWorld(e)),u.fullToTile=e=>({x:e.tileX,y:e.tileY}),u.fullToScreen=(e,t,i)=>b.worldToScreen(b.fullToWorld(e),t,i),u.getVisibleRect=(e,t)=>new v(e.position.x,e.position.y,e.position.x+s.screenSize.x/t.amount,e.position.y+s.screenSize.y/t.amount);var a=u;var g=class{},y=g;y.timeouts={},y.logEnabled=!1,y.enableLog=()=>g.logEnabled=!0,y.disableLog=()=>g.logEnabled=!1,y.start=(e="mark",t="default")=>{!s.performanceCategories[t]||performance.mark(`${e}_start`)},y.end=(e="mark",t,i="default")=>{let o=t?`${e}: ${t}`:e;s.performanceCategories[i]&&(performance.mark(`${e}_end`),performance.measure(o,`${e}_start`,`${e}_end`)),g.logEnabled&&console.debug(o)},y.track=(e="mark",t,i="default")=>{!s.performanceCategories[i]||(g.timeouts.hasOwnProperty(e)?clearTimeout(g.timeouts[e]):g.start(e,i),g.timeouts[e]=setTimeout(()=>g.stopTracking(e,i),t))},y.stopTracking=(e,t="default")=>{!s.performanceCategories[t]||g.timeouts.hasOwnProperty(e)&&(g.end(e),clearTimeout(g.timeouts[e]),delete g.timeouts[e])},y.getAverage=(e="mark")=>{let t=performance.getEntriesByName(e).filter(i=>i.entryType==="measure");return t.reduce((i,o)=>i+o.duration,0)/t.length};var f=y;var k=class{constructor(e,t,i,o){this.tileStore=e;this.renderer=t;this.permissions=i;this.coords=o;this.dirty=!0;this.initted=!1;this.content=[];this.pendingEdits=[];this.highlights=[];this.writability=k.defaultPermission;this.cellProps=[];this.cursors=[];this.canvas=null;this.ctx=null;this.getContent=()=>this.content;this.setContent=e=>{e=e.padEnd(s.numRows*s.numCols," "),x.getChars(e).forEach((t,i)=>{if(!this.pendingEdits.find(r=>r.index===i)){let{row:r,col:n}=k.cellIndexToRC(i);this.setCell(r,n,t)}}),this.dirty=!0,this.initted=!0};this.setCell=(e,t,i)=>{let o=e*s.numCols+t;this.content[o]!==i&&this.canHighlight()&&this.highlightCell(o),this.content[o]=i,this.dirty=!0};this.highlightCell=e=>{this.highlights.find(([t,i])=>t===e)||(this.highlights.push([e,performance.now()]),this.markDirty())};this.canHighlight=()=>{if(!this.initted)return!1;let e=Math.floor(performance.now()/1e3);return k.inkLimiter.timestamp!==e?(k.inkLimiter.timestamp=e,k.inkLimiter.limit=10,!0):(k.inkLimiter.limit-=1,k.inkLimiter.limit>=0)};this.isDirty=()=>this.dirty;this.markDirty=()=>this.dirty=!0;this.isEditable=()=>this.permissions.canEditTile(this);this.tellEdit=e=>{C(this.initted,"Can't edit uninitialized tile");let t=e.charIndex(),i=this.pendingEdits.find(o=>o.index===t);i&&i.timestamp<e.timestamp?(i.timestamp=e.timestamp,i.char=e.char):this.pendingEdits.push({index:t,char:e.char,timestamp:e.timestamp})};this.editDone=e=>{let t=e.charIndex();this.pendingEdits=this.pendingEdits.filter(i=>i.index!==t)};this.update=e=>{e===null?(this.setContent(""),this.cellProps=[]):(this.setContent(e.content),this.setCellProps(e.properties.cell_props),this.writability=e.properties.writability,this.writability===null&&(this.writability=k.defaultPermission))};this.getCellProps=(e,t)=>this.cellProps[e]?this.cellProps[e][t]:null;this.setCellProps=e=>{this.cellProps=[];for(let t=0;t<s.numCols;t++){this.cellProps[t]=[];for(let i=0;i<s.numCols;i++){let o=e[i]&&e[i][t];this.cellProps[t][i]=o}}};this.render=e=>(this.dirty&&(f.start("Tile render"),this.canvas||this.hydrate(),this.setCursors(e),this.renderer.render(this,this.ctx),this.highlights.length===0&&(this.dirty=!1),f.end("Tile render")),this.canvas);this.setCursors=e=>{this.cursors=e.filter(t=>{let i=t.getRect().sub(this.getRect());return this.containsCursor(i)})};this.getCursors=()=>this.cursors;this.getHighlights=()=>{let e=performance.now();return this.highlights=this.highlights.filter(([t,i])=>e-i<s.highlightTime),this.highlights};this.getRect=()=>{let e=this.position.x,t=this.position.y;return new v(e,t,e+s.tileWidth,t+s.tileHeight)};this.containsCursor=e=>e.left<s.tileWidth&&e.right>-s.tileWidth&&e.top<s.tileHeight&&e.bottom>-s.tileHeight;this.getColor=()=>{switch(this.writability){case m.ADMIN:return s.colors.ownerTile;case m.MEMBERS:return s.colors.memberTile;case m.PUBLIC:return s.colors.publicTile;default:return s.colors.publicTile}};this.isInRect=e=>new v(e.left-s.tileWidth,e.top-s.tileHeight,e.right,e.bottom).contains(this.position);this.dehydrate=()=>{this.ctx=null,this.canvas=null,this.dirty=!0};this.hydrate=()=>{this.canvas=this.tileStore.createCanvas(),this.canvas.width=this.renderer.canvas.width,this.canvas.height=this.renderer.canvas.height,this.ctx=this.canvas.getContext("2d")};this.hasCanvas=()=>this.canvas!==null;this.getCanvas=()=>this.canvas}get position(){return a.tileToWorld(this.coords)}get width(){return s.tileWidth}get height(){return s.tileHeight}},z=k;z.inkLimiter={timestamp:0,limit:10},z.cellIndexToRC=e=>{let t=Math.floor(e/s.numCols),i=e%s.numCols;return{row:t,col:i}},z.defaultPermission=m.PUBLIC;var L=z;var j=class{constructor(){this.render=(e,t)=>{this.ctx.fillStyle=e.getColor(),this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),e.getHighlights().forEach(([i,o])=>{let{row:r,col:n}=L.cellIndexToRC(i),h=n*s.cellWidth,p=r*s.cellHeight;this.ctx.fillStyle=this.highlightColor(o),this.ctx.fillRect(h,p,s.cellWidth,s.cellHeight)}),e.getCursors().forEach(i=>{if(i.isVisible()){let o=i.getRect(),r=o.sub(e.getRect());this.ctx.fillStyle=i.color,this.ctx.fillRect(r.left,r.top,o.width,o.height)}}),this.ctx.fillStyle="black",e.getContent().forEach((i,o)=>{let{row:r,col:n}=L.cellIndexToRC(o),h=n*s.cellWidth,p=r*s.cellHeight;this.ctx.fillStyle=this.cellColor(e,n,r),this.ctx.fillText(i,h,p+.5*s.cellHeight),e.getCellProps(n,r)&&(this.ctx.lineWidth=Math.ceil(window.devicePixelRatio),this.ctx.strokeStyle=this.cellColor(e,n,r),this.ctx.beginPath(),this.ctx.moveTo(h,p+s.cellHeight-3.5),this.ctx.lineTo(h+s.cellWidth-1,p+s.cellHeight-3.5),this.ctx.stroke())}),s.debug.drawTileBorders&&(this.ctx.lineWidth=1,this.ctx.strokeStyle="1px #ddd",this.ctx.strokeRect(0,0,this.canvas.width,this.canvas.height)),s.debug.drawTileCoords&&(this.ctx.fillStyle="black",this.ctx.fillText(`${e.coords.x},${e.coords.y}`,0,.5*s.cellHeight)),t.drawImage(this.canvas,0,0)};this.cellColor=(e,t,i)=>{let o=e.getCellProps(t,i);return o?o.link.type==="coord"?s.colors.coordLink:o.link.type==="url"?s.colors.urlLink:s.colors.text:s.colors.text};this.highlightColor=e=>{let t=parseInt(s.colors.cellHighlight.slice(1,3),16),i=parseInt(s.colors.cellHighlight.slice(3,5),16),o=parseInt(s.colors.cellHighlight.slice(5,7),16),r=(performance.now()-e)/s.highlightTime,n=1-this.easeOutQuad(r);return`rgba(${t}, ${i}, ${o}, ${n}`};this.easeOutQuad=e=>1-(1-e)*(1-e);this.canvas=document.createElement("canvas"),this.canvas.width=s.tileWidth,this.canvas.height=s.tileHeight,this.ctx=this.canvas.getContext("2d",{alpha:!1}),this.ctx.font=`${16*s.pixelScale}px Courier New`,this.ctx.textBaseline="middle"}},Ce=j;var W=class{constructor(e,t){this.permissions=e;this.numTiles=0;this.tiles={};this.canvasPool=[];this.getOrCreateTile=e=>{let t=this.getTile(e);return t||(t=this.createTile(e)),t};this.createTile=e=>{let t=new L(this,this.renderer,this.permissions,e);return this.tiles[W.tileKey(e)]=t,this.numTiles++,t};this.getTile=e=>this.tiles[W.tileKey(e)]||null;this.getTileAt=e=>this.getTile(a.worldToTile(e));this.getTiles=()=>Object.values(this.tiles);this.getTilesInRect=e=>{let t=[],i=a.worldToTile(e.topLeft),o=a.worldToTile(e.bottomRight);for(let r=i.x;r<o.x+1;r++)for(let n=i.y;n<o.y+1;n++){let h=this.getTile({x:r,y:n});h&&t.push(h)}return t};this.getCellLink=e=>{let t=this.getTile(a.fullToTile(e));if(t){let i=t.getCellProps(e.charX,e.charY);if(i)return i.link}return null};this.cleanUpTiles=e=>{for(let t in this.tiles){let i=this.tiles[t];e.contains(i.position)||(i.hasCanvas()&&(this.canvasPool.length<W.canvasPoolMax&&this.canvasPool.push(i.getCanvas()),i.dehydrate()),delete this.tiles[t])}};this.dirtyAll=()=>{for(let e in this.tiles)this.tiles[e].markDirty()};this.createCanvas=()=>this.canvasPool.length>0?this.canvasPool.pop():document.createElement("canvas");L.defaultPermission=t,this.renderer=new Ce}deleteTile(e){delete this.tiles[W.tileKey(e)],this.numTiles--}},D=W;D.tileKey=e=>`${e.y},${e.x}`,D.canvasPoolMax=500;var ve=D;var G=class{constructor(e,t){this.titleEl=e;this.menuEl=t;this._SPEED=250;this.addOption=(e,t)=>{let i=document.createElement("div");i.innerText=e,i.addEventListener("click",()=>{this.hideNow(),t()}),this.addEntry(i)};this.addCheckboxOption=(e,t,i)=>{let o,r;r=$(document.createElement("div")),r.text(e),o=document.createElement("input"),o.type="checkbox",r.prepend(o),r.on("click",n=>{n.target!==o&&(o.checked=!o.checked),o.checked?t():i()}),this.addEntry(r[0])};this.hideNow=()=>{this.menuEl.slideUp(this._SPEED),this.titleEl.removeClass("hover")};this.hide=()=>{$.data(this.menuEl,"cancelHide",!1),setTimeout(()=>{$.data(this.menuEl,"cancelHide")||this.hideNow()},500)};this.show=()=>{$.data(this.menuEl,"cancelHide",!0),this.menuEl.slideDown(this._SPEED),this.titleEl.addClass("hover")};this.addEntry=e=>{let t;this.menuEl.find("ul").append("<li></li>"),t=this.menuEl.find("li:last"),t.append(e),t.on("mouseenter",function(){$(this).addClass("hover"),$("> a",this).addClass("hover")}),t.on("mouseleave",function(){$(this).removeClass("hover"),$("> a",this).removeClass("hover")})};this.menuEl.css("top",this.titleEl.offset().top+this.titleEl.outerHeight()),this.titleEl.on("mouseenter",this.show),this.titleEl.on("mouseleave",this.hide),this.menuEl.on("mouseenter",this.show),this.menuEl.on("mouseleave",this.hide),this.titleEl.show()}},ye=G;var J=class{constructor(e,t){this.node=e;this.zoom=t;this.offset={x:0,y:0};this.grabbed=!1;this.lastPos={x:0,y:0};this.moveCallback=null;this.maxWheelSpeed=null;this.wheelDistance=0;this.animating=!1;this.onScroll=e=>{this.moveCallback=e};this.onAnimateStop=e=>{this.animateStopCallback=e};this.throttle=e=>{this.maxWheelSpeed=e};this.enableMomentum=()=>{this.momentum.enable()};this.disableMomentum=()=>{this.momentum.disable()};this.scroll=(e,t)=>{this.offset.x+=e,this.offset.y+=t,this.moveCallback&&this.moveCallback(this.offset,{x:e,y:t})};this.animateTo=(e,t)=>{this.target={x:e,y:t},this.animating=!0};this.animateStop=()=>{this.animating=!1,this.animateStopCallback()};this.startGrab=e=>{f.start("Scroll (grab)","scrolling"),this.animating&&this.animateStop(),this.momentum.isEnabled()&&this.momentum.stop();let t=e.clientX*s.pixelScale/this.zoom.amount,i=e.clientY*s.pixelScale/this.zoom.amount;this.grabbed=!0,this.lastPos.x=t,this.lastPos.y=i,this.node.style.cursor="move"};this.onMove=e=>{if(!this.grabbed)return;let t=e.clientX*s.pixelScale/this.zoom.amount,i=e.clientY*s.pixelScale/this.zoom.amount,o=this.lastPos.x-t,r=this.lastPos.y-i;o===0&&r===0||(this.lastPos.x=t,this.lastPos.y=i,this.momentum.updateVelocity(o,r),this.scroll(o,r))};this.stopGrab=e=>{if(this.grabbed){f.end("Scroll (grab)","scrolling");let t=e.clientX*s.pixelScale/this.zoom.amount,i=e.clientY*s.pixelScale/this.zoom.amount,o=this.lastPos.x-t,r=this.lastPos.y-i;this.lastPos.x=e.clientX*s.pixelScale,this.lastPos.y=e.clientY*s.pixelScale,this.momentum.updateVelocity(o,r,!0)}this.grabbed=!1,this.node.style.cursor="",this.momentum.isEnabled()&&e.type==="mouseup"&&this.momentum.start()};this.onTouchMove=e=>{this.grabbed||(this.grabbed=!0,this.touchId=e.touches[0].identifier,this.lastPos.x=e.touches[0].screenX*s.pixelScale,this.lastPos.y=e.touches[0].screenY*s.pixelScale,this.momentum.isEnabled()&&this.momentum.stop()),e.preventDefault();let t=Array.from(e.touches).find(r=>r.identifier===this.touchId),i=this.lastPos.x-t.screenX*s.pixelScale,o=this.lastPos.y-t.screenY*s.pixelScale;this.momentum.updateVelocity(i,o),!(i===0&&o===0)&&(this.lastPos.x=t.screenX*s.pixelScale,this.lastPos.y=t.screenY*s.pixelScale,this.scroll(i,o))};this.onTouchEnd=e=>{e.touches.length===0?(this.grabbed=!1,this.momentum.isEnabled()&&this.momentum.velocityHasRecentlyUpdated()&&this.momentum.start()):Array.from(e.changedTouches).find(i=>i.identifier===this.touchId)&&(this.touchId=e.touches[0].identifier,this.lastPos.x=e.touches[0].screenX*s.pixelScale,this.lastPos.y=e.touches[0].screenY*s.pixelScale)};this.onWheel=e=>{if(e.ctrlKey)return;f.track("Scroll (wheel)",50,"scrolling");let t=e.deltaX*devicePixelRatio,i=e.deltaY*devicePixelRatio,o=Math.sqrt(Math.pow(t,2)+Math.pow(i,2));if(this.maxWheelSpeed){let r=this.maxWheelSpeed-this.wheelDistance,n=Math.min(r,o);if(n<=0)return;this.wheelDistance+=n,setTimeout(()=>this.wheelDistance-=n,100),t*=n/o,i*=n/o}this.scroll(t,i)};this.animateMove=e=>{if(!this.animating)return;let t=800/e,i=this.target.x-this.offset.x,o=this.target.y-this.offset.y,r=x.vectorLen(o,i),n=Math.round(i*t/r),h=Math.round(o*t/r);if(r<20){this.animateStop();return}this.scroll(n,h)};this.isAnimating=()=>this.animating;this.momentum=new xe(this.scroll),this.offset={x:0,y:0},e.addEventListener("mousedown",this.startGrab),e.addEventListener("mousemove",this.onMove),e.addEventListener("mouseup",this.stopGrab),e.addEventListener("mouseleave",this.stopGrab),e.addEventListener("mousewheel",this.onWheel,{passive:!0}),e.addEventListener("wheel",this.onWheel,{passive:!0}),e.addEventListener("touchmove",this.onTouchMove,{passive:!1}),e.addEventListener("touchend",this.onTouchEnd)}get x(){return this.offset.x}get y(){return this.offset.y}get position(){return this.offset}},O=J,xe=class{constructor(e){this.scroll=e;this.velocity={x:0,y:0};this.velocityCheckInterval=35;this.delta={x:0,y:0};this.lastPos={x:0,y:0};this.lastUpdate=0;this.start=()=>{this.stop(!0),this.startTime=performance.now(),this.moveTimeout=setTimeout(this.move,10)};this.stop=(e=!1)=>{clearTimeout(this.moveTimeout),this.lastUpdate=performance.now(),this.delta.x=0,this.delta.y=0,e||(this.velocity.x=0,this.velocity.y=0),this.lastPos.x=0,this.lastPos.y=0};this.enable=()=>{this.enabled=!0};this.disable=()=>{this.enabled=!1};this.velocityHasRecentlyUpdated=()=>performance.now()-this.lastUpdate<100;this.isEnabled=()=>this.enabled;this.move=()=>{if(!this.enabled)return;let e=performance.now()-this.startTime;e=Math.floor(e/4);let t=this.velocity.x/9,i=this.velocity.y/9;t=this.calcPosition(t,1.03,e),i=this.calcPosition(i,1.03,e);let o=t-this.lastPos.x,r=i-this.lastPos.y;Math.trunc(o)==0&&(o=0),Math.trunc(r)==0&&(r=0),!(o==0&&r==0)&&(this.scroll(Math.trunc(o),Math.trunc(r)),this.lastPos.x=t,this.lastPos.y=i,this.moveTimeout=setTimeout(this.move,10))};this.calcPosition=(e,t,i)=>{var i=e*(t-ue(t,-i-1))/(t-1);return i};this.updateVelocity=(e,t,i)=>{if(!this.enabled)return;let o=performance.now(),r=o-this.lastUpdate;if(i&&r>100){this.stop();return}if(this.delta.x+=e,this.delta.y+=t,r>this.velocityCheckInterval){let n=100*window.devicePixelRatio,h=x.vectorLen(this.delta.x,this.delta.y),p=h>n?n/h:1;this.velocity.x=p*this.delta.x,this.velocity.y=p*this.delta.y,this.lastUpdate=o,this.delta.x=0,this.delta.y=0}};this.stop(),this.enable()}};var Ue=200,I=class{constructor(e,t,i){this.sendQueue={edits:[],tiles:[],cursor:null,position:null};this.lastPosition=null;this.inFlight={tiles:[],edits:[]};this.sendRates={fetch:{count:0,sentAt:0},write:{count:0,sentAt:0},cursor:{count:0,sentAt:0},position:{count:0,sentAt:0}};this.channel=null;this.sendEdit=e=>{this.inFlight.edits.push(e),this.sendQueue.edits.push(e)};this.fetchTiles=e=>{let t=e.filter(i=>{let o=this.inFlight.tiles.find(n=>n.coords.find(h=>h.x===i.x&&h.y===i.y)),r=this.sendQueue.tiles.find(n=>n.x===i.x&&n.y===i.y);return!o&&!r});t.length!==0&&(this.sendQueue.tiles=this.sendQueue.tiles.concat(t))};this.linkCellCoords=(e,t,i)=>{$.ajax({type:"POST",url:"/ajax/coordlink/",data:_(V({world:e},t),{link_tileX:i.x,link_tileY:i.y})})};this.linkCellUrl=(e,t,i)=>{$.ajax({type:"POST",url:"/ajax/urllink/",data:_(V({world:e},t),{url:i})})};this.protectTile=(e,t,i)=>{let o={type:fe(i),tileX:t.coords.x,tileY:t.coords.y,world:e};$.ajax({type:"POST",url:"/ajax/protect/",data:o})};this.unprotectTile=(e,t)=>{let i={tileX:t.coords.x,tileY:t.coords.y,world:e};$.ajax({type:"POST",url:"/ajax/unprotect/",data:i})};this.onSocketOpen=()=>{this.flushTileQueue()};this.onSocketClose=()=>{this.inFlight.tiles.length>0&&(this.inFlight.tiles.forEach(e=>{this.sendQueue.tiles.concat(e.coords)}),this.inFlight.tiles=[])};this.onSocketMessage=e=>{let t=JSON.parse(e.data);t.kind==="channel"&&(this.channel=t.channel_name),!(t.kind==="cursor"&&t.sender===this.channel)&&(t.kind==="write"&&this.onWriteMessage(t),(t.kind==="fetch"||t.kind==="tileUpdate")&&this.onFetchMessage(t),t.kind==="error"&&this.onErrorMessage(t),this.messageHandlers[t.kind]&&this.messageHandlers[t.kind](t))};this.onWriteMessage=e=>{e.accepted.forEach(o=>{let r=this.inFlight.edits.find(h=>h.id===o),n=this.tileStore.getTile(r.tileCoords());n&&n.editDone(r)});let t=Object.keys(e.rejected).map(o=>parseInt(o));t.length>0&&console.warn(`${t.length} edits were rejected`);let i=t.concat(e.accepted);this.inFlight.edits=this.inFlight.edits.filter(o=>!i.find(r=>o.id===r))};this.onFetchMessage=e=>{this.inFlight.tiles=this.inFlight.tiles.filter(t=>t.request_id!==e.request_id),e.request_id>0&&f.end(`Fetch tiles ${e.request_id}`,`${Object.keys(e.tiles).length}`,"network")};this.onErrorMessage=e=>{if(e.error==="rate_limit_exceeded"){let t=this.inFlight.tiles.findIndex(i=>i.request_id===e.request_id);if(t>-1){let[i]=this.inFlight.tiles.splice(t,1);this.sendQueue.tiles.concat(i.coords)}}};this.getAddress=e=>{let t=window.location.protocol==="https:"?"wss":"ws",i=window.location.pathname.replace(/\/$/,"");return`${t}://${e}${i}/ws/`};this.flushCursorQueue=()=>{if(this.socket.readyState===WebSocket.OPEN&&this.sendQueue.cursor!==null&&this.requestRateOk("cursor")){let e={kind:"cursor",request_id:I.nextRequestId++,positions:[this.sendQueue.cursor]};try{this.socket.send(JSON.stringify(e)),this.sendQueue.cursor=null}catch(t){console.error(t)}}};this.flushPosition=()=>{if(this.socket.readyState===WebSocket.OPEN&&this.sendQueue.position!==null&&this.requestRateOk("position")){let e={kind:"position",request_id:I.nextRequestId++,position:this.sendQueue.position};try{this.socket.send(JSON.stringify(e)),this.lastPosition=this.sendQueue.position,this.sendQueue.position=null}catch(t){console.error(t)}}};this.flushEditQueue=()=>{if(this.socket.readyState===WebSocket.OPEN&&this.sendQueue.edits.length>0&&this.requestRateOk("write")){let e={kind:"write",request_id:I.nextRequestId++,edits:this.sendQueue.edits.slice(0,Ue).map(t=>t.serialize())};try{this.socket.send(JSON.stringify(e)),this.sendQueue.edits=[]}catch(t){console.error(t)}}};this.flushTileQueue=()=>{if(this.socket.readyState===WebSocket.OPEN&&this.sendQueue.tiles.length>0&&this.requestRateOk("fetch")){let e=this.getTileRects(this.sendQueue.tiles).map(o=>o.serialize()),t=I.nextRequestId++,i={kind:"fetch",request_id:t,fetchRectangles:e};try{this.socket.send(JSON.stringify(i)),f.start(`Fetch tiles ${t}`,"network"),this.inFlight.tiles.push({request_id:t,coords:this.sendQueue.tiles}),this.sendQueue.tiles=[]}catch(o){console.error(o)}}};this.getTileRects=e=>e.length===0?[]:e.map(t=>new v(t.x,t.y,t.x+1,t.y+1)).sort((t,i)=>t.top===i.top?t.left-i.left:t.top-i.top).reduce((t,i)=>{let o=t.findIndex(r=>r.sharesEdge(i));return o!==-1?t[o]=t[o].merge(i):t.push(i),t},[]);let o=this.getAddress(e);this.socket=new ReconnectingWebSocket(o),this.socket.onopen=this.onSocketOpen,this.socket.onclose=this.onSocketClose,this.socket.onmessage=this.onSocketMessage,this.tileStore=t,this.messageHandlers=i,this.messageHandlers.tileUpdate=this.messageHandlers.fetch,setInterval(this.flushTileQueue,10),setInterval(()=>{this.flushEditQueue(),this.flushCursorQueue(),this.flushPosition()},1e3)}sendCursor(e){this.sendQueue.cursor=e.getFullCoords()}sendPosition(e){this.lastPosition!==null&&this.lastPosition.x==e.x&&this.lastPosition.y==e.y||(this.sendQueue.position={x:e.x,y:e.y})}requestRateOk(e){let t=Math.floor(performance.now());return t>this.sendRates[e].sentAt+1e3?(this.sendRates[e].sentAt=t,this.sendRates[e].count=1,!0):this.sendRates[e].count<s.rateLimits[e]?(this.sendRates[e].count+=1,!0):!1}},q=I;q.nextRequestId=1;var Te=q;var ee=class{constructor(e){this.element=$("#announce"),this.close=$("#announce_close"),this.text=$("#announce_text"),this.source=e,this.close.click(t=>{this.element.hide(),this.storage.add(this.source.id)}),this.storage=new AnnouncementStorage}show(){this.storage.contains(this.source.id)||(this.text.html(this.source.text),this.element.show())}},Se=ee;var te=class{constructor(e,t){this.canvas=e;this.zoom=t;this.resizeCanvas=()=>{this.canvas.width=Math.round(window.innerWidth*s.pixelScale),this.canvas.height=Math.round(window.innerHeight*s.pixelScale),this.canvas.style.width=`${window.innerWidth}px`,this.canvas.style.height=`${window.innerHeight}px`,this.ctx.fillStyle="#eee",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)};this.renderLoop=(e,t,i)=>{let o=0,r=a.getVisibleRect(e,this.zoom),n=this.zoom.amount,h=p=>{let S=a.getVisibleRect(e,this.zoom),E=t.getTilesInRect(S),B=!S.equals(r),ce=n!=this.zoom.amount,R=E.some(w=>w.isDirty());if(r=S,n=this.zoom.amount,!B&&!ce&&!R&&!e.isAnimating()){requestAnimationFrame(h);return}f.start("World render","rendering");let H=p-o;o=p;let M=0,P=0;if(this.ctx.fillStyle="#ddd",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),e.animateMove(H),E.length===0){this.ctx.fillStyle="black";let w=32*s.pixelScale;this.ctx.font=`bold ${w}px Verdana`,this.ctx.textBaseline="bottom",this.ctx.fillText("Loading...",0,w+7*s.pixelScale)}let Pe=performance.now();E.forEach(w=>{let Le=performance.now()-Pe,We=a.worldToScreen(w.position,e,this.zoom);w.isDirty()&&Le<s.renderThreshhold&&(M++,w.render(i())),w.hasCanvas()&&(this.drawTile(w.getCanvas(),We),P++)});let ze=Math.round(100*this.zoom.amount);f.end("World render",`Rendered ${M}, drew ${P} of ${E.length} (${ze}% zoom)`,"rendering"),requestAnimationFrame(h)};requestAnimationFrame(h)};this.drawTile=(e,t)=>{this.ctx.drawImage(e,0,0,Math.floor(e.width),Math.floor(e.height),Math.floor(t.x),Math.floor(t.y),Math.ceil(s.tileWidth*this.zoom.amount),Math.ceil(s.tileHeight*this.zoom.amount))};this.ctx=this.canvas.getContext("2d"),this.resizeCanvas()}get width(){return this.canvas.width}get height(){return this.canvas.height}},we=te;var ie=class{constructor(e,t,i){this.char=e;this.coords=t;this.timestamp=i;this.tileCoords=()=>({x:this.coords.tileX,y:this.coords.tileY});this.charIndex=()=>this.coords.charY*s.numCols+this.coords.charX;this.serialize=()=>[this.coords.tileY,this.coords.tileX,this.coords.charY,this.coords.charX,this.timestamp,this.char,this.id];C(x.length(e)===1),this.id=ie.nextId++}},Y=ie;Y.nextId=1;var ke=Y;var se=class{constructor(e,t){this.element=e;this.cursor=t;this.value=[];this.canPaste=!1;this.listening=!1;this.editCallback=e=>{};this.escapeCallback=()=>{};this.isListening=()=>this.listening;this.listen=(e=!0)=>{this.listening=e,this.cursor.listen(e),this.cursor.setVisible(e)};this.onEdit=e=>{this.editCallback=e};this.onEscape=e=>{this.escapeCallback=e};this.allowPasting=(e=!0)=>{this.canPaste=e};this.clear=()=>{this.value=[],this.element.value=""};this.showKeyboard=()=>{this.element.focus({preventScroll:!0}),window.scrollTo(0,0)};this.hideKeyboard=()=>{this.element.blur()};this.isFocused=()=>document.activeElement===this.element;this.typeNextChar=()=>{if(this.value.length===0)return;let e=this.value.shift();this.cursor.getTile().isEditable()&&(e===`
`?this.cursor.move("return"):(this.typeChar(e),this.cursor.move("right")))};this.typeChar=e=>{C(x.length(e)===1);let t=this.cursor.getTile();if(!t.isEditable())return;let i=this.cursor.getFullCoords();t.setCell(i.charY,i.charX,e);let o=new ke(e,i,new Date().getTime());t.tellEdit(o),this.editCallback(o)};this.onInput=e=>{if(!this.listening){this.element.value="";return}e.data&&(this.value=x.getChars(e.data),this.element.value=""),e.inputType==="insertFromPaste"&&this.cursor.setReturn(this.cursor.x)};this.onPaste=e=>{if(!this.listening)return;let t=e.clipboardData.getData("text");t&&(this.value=x.getChars(t))};this.onKeydown=e=>{if(!!this.listening){switch(this.element.focus({preventScroll:!0}),e.key){case"Backspace":this.cursor.move("left"),this.typeChar(" ");break;case"Escape":this.escapeCallback();break;case"Enter":this.cursor.move("return");break}this.element.value=""}};document.addEventListener("keydown",this.onKeydown),e.addEventListener("input",this.onInput),e.addEventListener("paste",this.onPaste),this.listen(!1),setInterval(()=>{this.typeNextChar(),this.canPaste||this.clear()},10)}},Me=se;var oe=class{constructor(e,t,i,{enableListening:o=!1,visible:r=!0}){this.tileStore=e;this.scroller=t;this.zoom=i;this.position={x:0,y:0};this.returnColumn=0;this.listening=!0;this.visible=!0;this.cursorCallback=()=>{};this.size={x:1,y:1};this.color=s.colors.inputCursor;this.listen=(e=!0)=>this.listening=e;this.onMove=e=>this.cursorCallback=e;this.setSize=(e,t)=>{this.size.x=e,this.size.y=t};this.move=e=>{switch(e){case"up":this.setPosition({x:this.position.x,y:this.position.y-1});break;case"down":this.setPosition({x:this.position.x,y:this.position.y+1});break;case"left":this.setPosition({x:this.position.x-1,y:this.position.y});break;case"right":this.setPosition({x:this.position.x+1,y:this.position.y});break;case"return":this.setPosition({x:this.returnColumn,y:this.position.y+1});break}this.ensureVisible()};this.setFullCoords=(e,t={setReturn:!1})=>{this.setPosition(a.fullToCell(e),t)};this.setPosition=(e,t={setReturn:!1})=>{let i=this.isVisible();i&&this.hide(),this.position.x=e.x,this.position.y=e.y,t.setReturn&&(this.returnColumn=this.position.x),i&&this.show(),this.cursorCallback(this)};this.setReturn=e=>{this.returnColumn=e};this.setVisible=e=>{e?this.show():e||this.hide()};this.show=()=>{this.visible=!0,this.getTiles().forEach(e=>{e.markDirty()})};this.hide=()=>{this.visible=!1,this.getTiles().forEach(e=>{e.markDirty()})};this.isVisible=()=>this.visible;this.getFullCoords=()=>a.cellToFullCoords(this.position);this.getRect=()=>{let e=a.cellToWorld(this.position),t=a.cellToWorld({x:this.position.x+this.width,y:this.position.y+this.height});return new v(e.x,e.y,t.x,t.y)};this.getTile=()=>this.tileStore.getTileAt(a.cellToWorld(this.position));this.getTiles=()=>this.tileStore.getTilesInRect(this.getRect());this.onKeydown=e=>{if(!!this.listening)switch(e.key){case"ArrowLeft":this.move("left"),this.returnColumn=this.position.x;break;case"ArrowRight":this.move("right"),this.returnColumn=this.position.x;break;case"ArrowDown":this.move("down"),this.returnColumn=this.position.x;break;case"ArrowUp":this.move("up"),this.returnColumn=this.position.x;break}};this.ensureVisible=()=>{let e=this.getRect().sub(a.getVisibleRect(this.scroller,this.zoom)),t=0,i=0;e.left<0?t=e.left:e.right>0&&(t=e.right),e.top<0?i=e.top:e.bottom>0&&(i=e.bottom),(t!==0||i!==0)&&this.scroller.scroll(t,i)};o&&document.addEventListener("keydown",this.onKeydown),this.visible=r}get x(){return this.position.x}get y(){return this.position.y}get width(){return this.size.x}get height(){return this.size.y}},U=oe;var re=class{constructor(e,t,i,o){this.container=e;this.zoom=t;this.scroller=i;this.cursor=o;this.listening=!0;this.nextSelectCallback=null;this.hoverCallback=()=>{};this.selectCallback=()=>{};this.touchSelectCallback=()=>{};this.touchMoving=!1;this.touchSelect=!1;this.keepSelecting=!1;this.getCursor=()=>this.cursor;this.listen=(e=!0)=>{this.listening=e};this.onSelect=e=>{this.selectCallback=e};this.onTouchSelect=e=>{this.touchSelectCallback=e};this.onHover=e=>{this.hoverCallback=e};this.onNextSelect=(e,t=!1)=>{this.keepSelecting=t,this.nextSelectCallback=e};this.cancelSelect=()=>{this.resetCursor(),this.nextSelectCallback=null,this.cursor.getTile().markDirty()};this.selectCell=(e,t)=>{this.cursor.color=e,this.cursor.show(),this.onNextSelect(i=>{this.keepSelecting||this.resetCursor(),t(i)},!0)};this.selectTile=(e,t)=>{this.cursor.setSize(s.numCols,s.numRows),this.cursor.color=e,this.container.style.cursor="pointer",this.cursor.show(),this.onNextSelect(i=>{this.keepSelecting||this.resetCursor(),t(this.cursor.getTile())},!0)};this.resetCursor=()=>{this.cursor.hide(),this.cursor.setSize(1,1),this.cursor.color=s.colors.mouseCursor};this.onMove=e=>{if(!this.listening)return;let t=this.pickCell(e.clientX,e.clientY);t.charX=Math.floor(t.charX/this.cursor.width),t.charY=Math.floor(t.charY/this.cursor.height),this.cursor.setFullCoords(t),this.hoverCallback(t)};this.onClick=e=>{if(!this.listening)return;let t=this.pickCell(e.clientX,e.clientY);this.nextSelectCallback&&(this.nextSelectCallback(t),this.keepSelecting||(this.nextSelectCallback=null)),this.touchSelect?(this.touchSelect=!1,this.touchSelectCallback(t)):this.selectCallback(t)};this.onTouchMove=e=>{!this.listening||(this.touchMoving=!0)};this.onTouchEnd=e=>{if(!!this.listening&&!(e.touches.length>0)){if(this.touchMoving){this.touchMoving=!1;return}this.touchSelect=!0}};this.pickCell=(e,t)=>a.worldToFull(a.cssToWorld({x:e,y:t},this.scroller,this.zoom));e.addEventListener("mousemove",this.onMove),e.addEventListener("click",this.onClick),e.addEventListener("touchend",this.onTouchEnd),e.addEventListener("touchmove",this.onTouchMove,{passive:!0}),this.resetCursor()}},Ee=re;var le=class{constructor(e){this.zoomLevels=[.5,.67,.8,.9,1];this.zoomAmount=1;this.changeCallback=()=>{};this.sensitivity=.02;this.enableListening=e=>{if("GestureEvent"in window){let t;e.addEventListener("gesturestart",i=>{t=this.amount}),e.addEventListener("gesturechange",i=>{this.zoom(i.scale*t)})}else e.addEventListener("wheel",t=>{if(t.ctrlKey){t.preventDefault(),t.stopImmediatePropagation();let i=t.deltaY<0?"in":"out";f.track(`Zoom ${i} (wheel)`,50),this.zoom(this.zoomAmount-t.deltaY*this.sensitivity)}},{passive:!1})};this.disableNativeZoom=e=>{e.addEventListener("wheel",t=>{t.ctrlKey&&(t.preventDefault(),t.stopImmediatePropagation())},{passive:!1})};this.onChange=e=>{this.changeCallback=e};this.zoomIn=()=>{if(this.zoomAmount>=this.maxAmount)return;let e=this.zoomLevels.find(t=>t>this.zoomAmount);this.zoom(e)};this.zoomOut=()=>{if(this.zoomAmount<=this.minAmount)return;this.zoomLevels.reverse();let e=this.zoomLevels.find(t=>t<this.zoomAmount);this.zoomLevels.reverse(),this.zoom(e)};this.zoom=e=>{e>this.zoomLevels[this.zoomLevels.length-1]?e=this.zoomLevels[this.zoomLevels.length-1]:e<this.zoomLevels[0]&&(e=this.zoomLevels[0]);let t=this.amount;this.zoomAmount=e,this.changeCallback(this.amount,t)};e&&(this.zoomLevels=e,this.amount<this.minAmount&&(this.zoomAmount=this.minAmount),this.amount>this.maxAmount&&(this.zoomAmount=this.maxAmount))}get amount(){return this.zoomAmount}get minAmount(){return this.zoomLevels[0]}get maxAmount(){return this.zoomLevels[this.zoomLevels.length-1]}},X=le;var ne=class{constructor(e,t,i,o){this.canvas=e;this.tileStore=t;this.worldScroller=i;this.worldZoom=o;this.resizeCanvas=(e,t)=>{this.canvas.width=Math.round(e*s.pixelScale),this.canvas.height=Math.round(t*s.pixelScale),this.canvas.style.width=`${e}px`,this.canvas.style.height=`${t}px`,this.ctx.fillStyle="#eee",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)};this.renderLoop=()=>{let e=0,t=a.getVisibleRect(this.scroller,this.zoom),i=a.getVisibleRect(this.worldScroller,this.worldZoom),o=this.zoom.amount,r=n=>{let h=a.getVisibleRect(this.scroller,this.zoom),p=a.getVisibleRect(this.worldScroller,this.worldZoom),S=this.tileStore.getTilesInRect(h),E=!h.equals(t)||!p.equals(i),B=o!=this.zoom.amount,ce=S.some(M=>M.isDirty());if(t=h,i=p,o=this.zoom.amount,!E&&!B){requestAnimationFrame(r);return}this.ctx.fillStyle="#ddd",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),S.forEach(M=>{let P=a.worldToScreen(M.position,this.scroller,this.zoom);M.hasCanvas()?this.drawTile(M.getCanvas(),P):(this.ctx.fillStyle="#eee",this.ctx.fillRect(P.x,P.y,Math.ceil(s.tileWidth*this.zoom.amount),Math.ceil(s.tileHeight*this.zoom.amount)))});let R=a.worldToScreen(p.topLeft,this.scroller,this.zoom),H=a.worldToScreen(p.bottomRight,this.scroller,this.zoom);this.ctx.strokeStyle="#000",this.ctx.strokeRect(R.x,R.y,H.x-R.x,H.y-R.y),requestAnimationFrame(r)};requestAnimationFrame(r)};this.drawTile=(e,t)=>{this.ctx.drawImage(e,0,0,Math.floor(e.width),Math.floor(e.height),Math.floor(t.x),Math.floor(t.y),Math.ceil(s.tileWidth*this.zoom.amount),Math.ceil(s.tileHeight*this.zoom.amount))};this.ctx=this.canvas.getContext("2d"),this.zoom=new X([.05,.1]),this.zoom.enableListening(this.canvas),this.scroller=new O(e,this.zoom),this.resizeCanvas(this.canvas.clientWidth,this.canvas.clientHeight),this.scroller.scroll(-.5*s.screenSize.x,-.5*s.screenSize.y)}get width(){return this.canvas.width}get height(){return this.canvas.height}},Re=ne;var ae=class{constructor(e,t,i=window.location.host){this.container=e;this.guestCursors={};this.acceptCallback=()=>{};this.setWorldColors=e=>{s.setColor("text",e.text),s.setColor("inputCursor",e.cursor),s.setColor("guestCursor",e.cursor_guest),s.setColor("publicTile",e.background),s.setColor("memberTile",e.member_area),s.setColor("ownerTile",e.owner_area),this.tileStore.getTiles().forEach(t=>t.markDirty())};this.onScroll=(e,t)=>{if(t.x!==0||t.y!==0){this.checkBoundsAndFetch(s.fetchRect());let i=a.getVisibleRect(this.scroller,this.zoom).center();this.socket.sendPosition(a.worldToTile(i)),s.debug.preserveTiles||this.tileStore.cleanUpTiles(s.cleanupRect().offset(this.scroller.position)),this.updateDisplayCoords()}};this.onEdit=e=>{this.socket.sendEdit(e)};this.checkBoundsAndFetch=e=>{let t=[],i=a.screenToTile(e.topLeft,this.scroller,this.zoom),o=a.screenToTile(e.bottomRight,this.scroller,this.zoom);for(let r=i.x;r<o.x+1;r++)for(let n=i.y;n<o.y+1;n++){let h={x:r,y:n};this.tileStore.getTile(h)||t.push(h)}t.length>0&&this.socket.fetchTiles(t)};this.updateTiles=e=>{let t=!1,i=a.cellToTile(this.input.cursor);for(let o in e){let r=e[o],[n,h]=o.split(","),p={x:parseInt(h),y:parseInt(n)},S=this.tileStore.getOrCreateTile(p);S.update(r),i.x===S.coords.x&&i.y===S.coords.y&&(t=!0)}t&&this.input.isListening()&&this.updateInputForTile(this.input)&&this.socket.sendCursor(this.input.cursor)};this.updateInputForTile=e=>{let t=e.isListening(),i=e.cursor.getTile();if(i){let r=i.isEditable();this.input.listen(r)}else this.input.listen(this.permissions.canWrite());return t!==this.input.isListening()};this.onInputCursorMove=e=>{this.input.isListening()&&(this.updateInputForTile(this.input),this.socket.sendCursor(e))};this.getCursors=()=>[...Object.values(this.guestCursors),this.input.cursor,this.cellSelector.getCursor()];this.removeCursorAt=e=>{for(let t in this.guestCursors){let i=this.guestCursors[t],o=i.getFullCoords();if(o.tileX===e.tileX&&o.tileY===e.tileY&&o.charX===e.charX&&o.charY===e.charY){i.hide(),delete this.guestCursors[t];break}}};this.centerCursor=()=>{let e=a.getVisibleRect(this.scroller,this.zoom).center(),t=a.worldToFull(e);this.input.cursor.setFullCoords(t,{setReturn:!0}),this.updateDisplayCoords()};this.onCellHover=e=>{if(!this.cellSelector.getCursor().isVisible()){let t=this.tileStore.getCellLink(e);if(t){this.container.style.cursor="pointer";let i="";t.type==="coord"?i=`Link to coordinates ${t.link_tileX},${t.link_tileY}`:t.type==="url"&&(i=`Link to URL ${t.url}`),this.container.setAttribute("title",i)}else this.container.style.cursor==="pointer"&&(this.container.style.cursor="initial",this.container.setAttribute("title",""))}};this.onCellSelect=e=>{this.input.listen(),this.input.cursor.setFullCoords(e,{setReturn:!0});let t=this.tileStore.getCellLink(e);if(t)switch(t.type){case"coord":this.goToCoord({x:t.link_tileX,y:t.link_tileY});break;case"url":window.open(t.url);break}else this.input.clear(),this.input.showKeyboard()};this.onTouchCellSelect=e=>{let t=a.fullToScreen(e,this.scroller,this.zoom);if(t.y+s.cellHeight>.5*this.container.height){let i=t.y+s.cellHeight-.5*this.container.height;this.scroller.scroll(0,i)}this.onCellSelect(e)};this.buildMenu=()=>{let e;e=new ye($("#menu"),$("#nav")),e.addCheckboxOption(" Show coordinates",()=>$("#coords").show(),()=>$("#coords").hide()),this.permissions.canGoToCoord()&&e.addOption("Go to coordinates",()=>{this.coordinateInputModal.open("Go to coordinates:",this.goToCoord)}),this.permissions.canCoordlink()&&e.addOption("Create link to coordinates",()=>{this.coordinateInputModal.open("Enter the coordinates to create a link to. You can then click on a letter to create the link.",t=>{this.onAccept(()=>{this.cellSelector.cancelSelect()}),this.cellSelector.selectCell(s.colors.mouseCursor,i=>{this.socket.linkCellCoords(this.worldModel.path,i,t)})})}),this.permissions.canUrllink()&&e.addOption("Create link to URL",()=>{this.urlInputModal.open(t=>{this.onAccept(()=>{this.cellSelector.cancelSelect()}),this.cellSelector.selectCell(s.colors.mouseCursor,i=>{this.socket.linkCellUrl(this.worldModel.path,i,t)})})}),this.permissions.canAdmin()&&e.addOption("Make an area owner-only",()=>{this.onAccept(()=>{this.cellSelector.cancelSelect()}),this.cellSelector.selectTile(s.colors.ownerTile,t=>{this.socket.protectTile(this.worldModel.path,t,m.ADMIN)})}),this.permissions.canProtectTiles()&&(e.addOption("Make an area member-only",()=>{this.onAccept(()=>{this.cellSelector.cancelSelect()}),this.cellSelector.selectTile(s.colors.memberTile,t=>{this.socket.protectTile(this.worldModel.path,t,m.MEMBERS)})}),e.addOption("Make an area public",()=>{this.onAccept(()=>{this.cellSelector.cancelSelect()}),this.cellSelector.selectTile(s.colors.publicTile,t=>{this.socket.protectTile(this.worldModel.path,t,m.PUBLIC)})}),e.addOption("Default area protection",()=>{this.onAccept(()=>{this.cellSelector.cancelSelect()}),this.cellSelector.selectTile(s.colors.publicTile,t=>{this.socket.unprotectTile(this.worldModel.path,t)})}))};this.setupUI=()=>{let e=document.getElementById("zoom-in");e&&e.addEventListener("click",()=>{this.zoom.zoomIn()});let t=document.getElementById("zoom-out");t&&t.addEventListener("click",()=>{this.zoom.zoomOut()});let i=document.getElementById("minimap");i&&s.debug.showMinimap&&(i.classList.remove("hidden"),this.minimap=new Re(i,this.tileStore,this.scroller,this.zoom));let o=document.getElementById("accept");o&&o.addEventListener("click",r=>{this.acceptCallback&&this.acceptCallback(),this.hideAccept()})};this.onAccept=e=>{this.acceptCallback=e,this.showAccept()};this.showAccept=()=>{let e=document.getElementById("accept");e&&e.classList.remove("hidden")};this.hideAccept=()=>{let e=document.getElementById("accept");e&&e.classList.add("hidden")};this.onZoom=(e,t)=>{let i=e/t-1,o=a.getVisibleRect(this.scroller,this.zoom).center(),r={x:(o.x-this.scroller.x)*i,y:(o.y-this.scroller.y)*i};this.scroller.scroll(r.x,r.y);let n=document.getElementById("zoom-label");n&&(e==1?n.classList.add("hidden"):(n.innerText=`${Math.round(e*100)}%`,n.classList.remove("hidden")))};this.onModalOpen=()=>{this.input.listen(!1),this.cellSelector.listen(!1)};this.onModalClose=()=>{this.input.listen(!0),this.cellSelector.listen(!0)};this.updateDisplayCoords=()=>{let e=a.worldToDisplay(a.getVisibleRect(this.scroller,this.zoom).center());document.getElementById("coord_X").textContent=`${e.x}`,document.getElementById("coord_Y").textContent=`${e.y}`};this.goToCoord=e=>{let t=a.displayToWorld(e),i=.5*s.screenSize.x/this.zoom.amount,o=.5*s.screenSize.y/this.zoom.amount;this.scroller.animateTo(t.x-i,t.y-o)};this.onResize=()=>{this.renderer.resizeCanvas(),s.setScreenSize(this.renderer.width,this.renderer.height),this.checkBoundsAndFetch(s.fetchRect())};this.wsAnnouncement=e=>{console.debug("wsAnnouncement",e),new Se(e.announcement).show()};this.wsFetch=e=>this.updateTiles(e.tiles);this.wsCursor=e=>{let t=e.positions[0],i=e.positions[e.positions.length-1];if(e.disconnected){this.removeCursorAt(t);return}let o=this.guestCursors[e.sender];o||(this.guestCursors[e.sender]=new U(this.tileStore,this.scroller,this.zoom,{}),o=this.guestCursors[e.sender],o.color=s.colors.guestCursor),o.setFullCoords(i),o.setVisible(e.visible)};this.wsColors=e=>{this.setWorldColors(e.colors)};this.container.style.display="block",this.worldModel=t.worldModel,this.userModel=t.userModel,this.permissions=new Z(this.userModel,this.worldModel),this.zoom=new X,this.permissions.canZoom()?this.zoom.enableListening(e):this.zoom.disableNativeZoom(e),this.zoom.onChange(this.onZoom),this.scroller=new O(this.container,this.zoom),this.scroller.throttle(100),this.scroller.onScroll(this.onScroll),this.scroller.onAnimateStop(this.centerCursor),this.tileStore=new ve(this.permissions,this.worldModel.writability),this.renderer=new we(this.container,this.zoom),this.setWorldColors(this.worldModel.colors),this.socket=new Te(i,this.tileStore,{announcement:this.wsAnnouncement,colors:this.wsColors,fetch:this.wsFetch,cursor:this.wsCursor});let o=new U(this.tileStore,this.scroller,this.zoom,{enableListening:!0});o.onMove(this.onInputCursorMove),this.input=new Me(document.querySelector("textarea#world-input"),o),this.input.allowPasting(this.permissions.canPaste()),this.input.onEdit(this.onEdit),this.input.onEscape(()=>{this.input.clear(),this.input.listen(!1),this.cellSelector.cancelSelect(),this.hideAccept()});let r=new U(this.tileStore,this.scroller,this.zoom,{visible:!1});this.cellSelector=new Ee(this.container,this.zoom,this.scroller,r),this.cellSelector.onHover(this.onCellHover),this.cellSelector.onSelect(this.onCellSelect),this.cellSelector.onTouchSelect(this.onTouchCellSelect),this.coordinateInputModal=new ge,this.coordinateInputModal.onOpen(this.onModalOpen),this.coordinateInputModal.onClose(this.onModalClose),this.urlInputModal=new be,this.urlInputModal.onOpen(this.onModalOpen),this.urlInputModal.onClose(this.onModalClose),this.buildMenu(),this.setupUI(),this.centerCursor(),window.addEventListener("resize",this.onResize),s.setScreenSize(this.renderer.width,this.renderer.height),this.scroller.scroll(-.5*s.screenSize.x,-.5*s.screenSize.y),this.renderer.renderLoop(this.scroller,this.tileStore,this.getCursors),this.minimap&&this.minimap.renderLoop(),this.checkBoundsAndFetch(s.fetchRect());let n=a.getVisibleRect(this.scroller,this.zoom).center();this.socket.sendPosition(a.worldToTile(n))}};document.addEventListener("DOMContentLoaded",()=>{pe();let l=new ae(document.querySelector("canvas#yourworld"),window.state);document.getElementById("loading").style.display="none",window.location.hostname==="localhost"&&(window.w=l)});})();